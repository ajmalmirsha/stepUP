<%- include("../layouts/header.ejs") %>

 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.1/dist/sweetalert2.all.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
    crossorigin="anonymous"></script>

    <div class="container-fluid">
       
      <div class="row align-items-center py-3 px-xl-5">
          <div class="col-lg-3 d-none d-lg-block" style="color: #D19C97;">
              <a href="" class="text-decoration-none " style="color: #D19C97;">
                  <h1  style="color: #D19C97;" class="m-0 display-5 font-weight-semi-bold"><span  class=" font-weight-bold border px-3 mr-1">
                      <i style="color: #D19C97;" class="fa-solid fa-shoe-prints"></i>
                      </span>
                      stepUP
                  </a>
          </div>
          <div class="col-lg-6 col-6 text-left">
              <!-- <form action="/search-product">
                  <div class="input-group">
                      <input type="text" class="form-control" name="search" placeholder="Search for products">
                      <div class="input-group-append">
                          <button type="submit" style="border: none;"><span  style="color: #D19C97;" class="input-group-text bg-transparent ">
                              <i class="fa fa-search"></i>
                          </span></button>
                        
                      </div>
                  </div>
              </form> -->
          </div>
          <div class="col-lg-3 col-6 text-right">
   <% if(typeof users !== 'undefined'){ %>
              <div class="dropdown my-2">
                  <button style="width: 40px;height: 40px;border: none;" class="bg-white" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <% if(users == true){ %>
                      <img style="width: 40px;height: 40px;border-radius: 50%;" src="https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8M3x8dXNlcnxlbnwwfHwwfHw%3D&w=1000&q=80" alt="">
                      <% } else{ %>
                          <img style="width: 40px;height: 40px;border-radius: 50%;" src="https://storage.needpix.com/rsynced_images/blank-profile-picture-973460_1280.png" alt="">
                          <% } %>
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                      <% if(users == true){ %>
                          <a class="dropdown-item" href="/user-profile">Profile</a>
                         <% } %>
                    <!-- <a class="dropdown-item" href="#">Another action</a> -->
                   
                    <% if(users == true){ %>
                    <a class="dropdown-item" href="/user_logout">Logout</a>
                    <% } else{ %>
                      <a class="dropdown-item" href="/user_login">login</a>
                      <% } %>
                     
                  </div>
                </div>
                 <% } %>
  <div>
      <a href="/show-wishlist" class="btn border">
                  <i style="color: #D19C97;" class="fas fa-heart "></i>
                
              </a>
        
              <a href="/show-cart" class="btn border">
                  <i  style="color: #D19C97;"  class="fas fa-shopping-cart"></i>
                  
              </a>
           
          </div>
              
  
              
            
          </div>
      </div>
  </div>
  
    <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-0">
                      <a href="" class="text-decoration-none d-block d-lg-none">
                          <h1 class="m-0 display-5 font-weight-semi-bold"><span class="text-primary font-weight-bold border px-3 mr-1">E</span>Shopper</h1>
                      </a>
                      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                          <span class="navbar-toggler-icon"></span>
                      </button>
                      <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                          <div class="navbar-nav m-auto py-0">
                              <a href="/userhome" class="nav-item nav-link">Home</a>
                              <a href="/shop" class="nav-item nav-link">Shop</a>
                              <a href="/orderlist" class="nav-item nav-link">Orders</a>
                              <div class="nav-item dropdown">
                                  <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Pages</a>
                                  <div class="dropdown-menu rounded-0 m-0">
                                      <a href="cart.html" class="dropdown-item">Shopping Cart</a>
                                      <a href="checkout.html" class="dropdown-item">Checkout</a>
                                  </div>
                              </div>
                              <a href="contact.html" class="nav-item nav-link">Contact</a>
                          </div>
                         
                      </div>
                  </nav>
    <div class="container">
        <div class="py-5 text-center">
          
        </div>
      
        <div  class="row">
          <div class="col-md-4 order-md-2 mb-4">
            <h4 class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-muted">Your cart</span>
              <span class="badge badge-secondary badge-pill">3</span>
            </h4>
            <ul class="list-group mb-3" id="copon_div">

             <% data.cart.forEach((x)=>{ %>
              <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                  <h6 class="my-0"><%- x.productId.productname %>  <span class="badge badge-secondary badge-pill"><%- x.qty %></span></h6>
                 
                  <small class="text-muted">Brief description</small>
                </div>
                <span class="text-muted">₹ <%- x.productTotalPrice %></span>
              </li>
             <% }) %>




           




         
              
              <li   class="list-group-item d-flex justify-content-between bg-light">
                <div class="text-success" >
                  <h6 id="coupon_name" class="my-0"></h6>
                 
                  <small id="coupon_code"></small>
                </div>
              <div style="display: inline;"></div> 
            <div><span  id="coupon_price" class="text-success"></span><span class="ml-3 w-25" style="border-radius: 50%; background-color: aliceblue;"><a style="color: black;text-decoration: none; cursor: pointer;" onclick="closeCOP()" id="cop_close"></a> </span></div> 

              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>SubTotal</span>
                <strong id="SubTotal">₹ <%- data.cartTotalPrice %></strong>
              </li>
              <li class="list-group-item  ">
                <span>Total</span>
                <strong id="Total" style="float: right;"><%- data.cartTotalPrice %></strong><strong style="float: right;">₹</strong>
                <div></div>
              </li>
            </ul>
      
            <form class="card p-2" id="addCoupon">
             
              
               
                <p class="text-danger" id="couponvalid"></p>
               
              <div class="input-group">
                <input type="text" name="code" class="form-control" placeholder="Promo code">
              
                <div class="input-group-append">
                  <button type="submit"  class="btn btn-secondary">Redeem</button>
                </div>
              </div>
            </form>
          </div>
          <form action="" method="" id="orderform">
            <input type="text" name="cop_code" id="cop_code" value="" hidden>
            <input type="text" name="SubTotal" value="<%- data.cartTotalPrice %>" hidden>
            <% data.cart.forEach((x)=>{ %>
            <input type="text" name="productId" value="<%- x.productId._id  %>" hidden>
            <input type="text" name="qty" value="<%- x.qty  %>" hidden>
            <input type="text" name="productTotalPrice"  value="<%- x.productTotalPrice  %>" hidden>


            <% }) %>
            <input type="text" name="userId" value="<%- data._id  %>" hidden>
            <input type="text" id="TotalPrice" name="cartTotalPrice" value="<%- data.cartTotalPrice  %>" hidden >
            
            
          <div class="col-md-8 order-md-1">
            <div id="address-div"> 
            <select id=""  required name="address" class="form-control form-control-chosen-required" data-placeholder="Please select...">
              <% data.address.forEach((x)=>{ %>
           <option ><%- x.name %> <br> <%- x.street %> <%- x.district %> <%- x.state %> <%- x.country %> <br> <%- x.phone %></option>
                <% }) %>i
              </select>
             </div>  
              <div><button type="button"   class="btn btn-outline-dark mt-4 mr-3" data-toggle="modal" data-target="#addressModal" data-mdb-ripple-color="dark"
                style="z-index: 1;display: block;float: right">
                Add Address
              </button></div>








              <hr class="mb-4">
            
             
      
              <h4 class="mb-3">Payment</h4>
      
              <div class="d-block my-3">
                <div class="custom-control custom-radio">
                  <input id="credit" name="paymentMethod" value="COD" type="radio" class="custom-control-input" checked required>
                  <label class="custom-control-label"  for="credit">COD</label>
                </div>
                <div class="custom-control custom-radio">
                  <input id="debit" name="paymentMethod" value="UPI" type="radio" class="custom-control-input" required>
                  <label class="custom-control-label" for="debit">Online Payment</label>
                </div>
                <div class="custom-control custom-radio">
                  <input id="wallet" name="paymentMethod" value="WALLET" type="radio" class="custom-control-input"  required>
                  <label class="custom-control-label"  for="wallet">Wallet</label>
                </div>
              <p class="text-danger" id="walletinsuf"></p>
              </div>
            
            
             
              
              <hr class="mb-4">
              <button class="btn btn-primary btn-lg btn-block" type="submit">Place Order</button>
            </form>
          </div>
        </div>
      
        <footer class="my-5 pt-5 text-muted text-center text-small">
          <p class="mb-1">&copy; 2017-2019 Company Name</p>
          <ul class="list-inline">
            <li class="list-inline-item"><a href="#">Privacy</a></li>
            <li class="list-inline-item"><a href="#">Terms</a></li>
            <li class="list-inline-item"><a href="#">Support</a></li>
          </ul>
        </footer>
      </div>



     <!-- Add Address -->
     


     
  <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add New Address</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          

          
          
          
          
          <form id="addAddress" >
            <div class="mb-3">
              <label for="exampleInputEmail1" class="form-label">Name</label>
              <input type="text" class="form-control"  name="name" id="exampleInputEmail1" aria-describedby="emailHelp" required>
              
               </div>
            <div class="mb-3">
              <label for="exampleInputPassword1" class="form-label">Street</label>
              <input type="text" name="street"  class="form-control" id="exampleInputPassword1" required>
            </div>
            <div class="mb-3">
              <label for="exampleInputPassword1" class="form-label">district</label>
              <input type="text" name="district"  class="form-control" id="exampleInputPassword1" required>
            </div>
            <div class="mb-3">
              <label for="exampleInputPassword1" class="form-label">State</label>
              <input type="text" name="state" class="form-control" id="exampleInputPassword1" required>
            </div>
            <div class="mb-3">
              <label for="exampleInputPassword1" class="form-label">country</label>
              <input type="text" name="country"  class="form-control" id="exampleInputPassword1" required>
            </div>
            <div class="mb-3">
              <label for="exampleInputPassword1" class="form-label">Phone number</label>
              <input type="number" name="phone" class="form-control" id="exampleInputPassword1" required>
            </div>
           <p class="text-danger" id="err"></p>
            <button type="submit"  class="btn btn-primary">Submit</button>
          </form>



      
 

     

        </div>
    
    
      </div>
    </div>
  </div>
  <!-- ------------------- -->



<!-- remove coupon -->
<script>
   function closeCOP(){
    $('#copon_div').load('/checkout #copon_div')
  }

</script>
 







    <!-- Ajax -->


    <!-- addAddresss -->
    <script>
   $('#addAddress').submit((event)=>{

  
event.preventDefault()
    $.ajax({
      url:'/add-checkout-address',
      method:"post",
      data:$('#addAddress').serialize(),
      success:(response)=>{
        Swal.fire({
  position: 'top-end',
  icon: 'success',
  title: 'address saved successfull',
  showConfirmButton: false,
  timer: 1500
}).then(()=>{
   $('#addressModal').on('hidden.bs.modal', function () {
                        $(this).find('form').trigger('reset');
                    });
                    $('#addressModal').modal('hide')
                    $('#address-div').load('/checkout #address-div')
})
       
          
                  }
      
    })



 
   })
    </script>

<!-- ------------------- -->


<!-- Add coupon -->

   <script>
       $('#addCoupon').submit((event)=>{
    event.preventDefault()
    $.ajax({
      url:'/coupon-apply',
      method:"post",
      data:$('#addCoupon').serialize(),
      success:(response)=>{
   
      console.log(response);
       $('#couponvalid').html(response.message)
       $("#coupon_name").html(response.coupondata.coupon_name)
       $("#coupon_code").html(response.coupondata.code)
       $("#coupon_price").html(response.coupondata.discountpercentage+"%")
       $("#Total").html(response.tprice)
       $("#cop_close").html('x')
       $("#TotalPrice").attr({value : response.tprice})
       $("#cop_code").attr({value : response.coupondata.code})


      }
      
    })
   })
   </script>


  <!-- place order -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    $("#orderform").submit((event)=>{
     
      console.log("orderrrrr forrmmm");
      event.preventDefault()
   
      const data = $("#orderform").serialize()
     
        $.ajax({
        url:"/place-order",
        method:'POST',
        data:data,
        success: (response)=>{
          console.log("succcc");
          if(response.success){
            
          location.href = '/ordersuccess'
          }else if (response.Razorpay){
            razorpayPayment(response.order)
          }else {
            console.log("elseeerrrr");
            $("#walletinsuf").html("wallet has insufficient balance !")
          }
      }
      })
    })
    function razorpayPayment (order){
      var options = {
    "key": "rzp_test_7HTD9tSiIzs8Qo", // Enter the Key ID generated from the Dashboard
    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "ajmal", //your business name
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
    "handler": function (response) {
       // alert(response.razorpay_payment_id);
       // alert(response.razorpay_order_id);
       // alert(response.razorpay_signature)

       verifyPayment(response,order)
        },
    "prefill": {
        "name": "ajmal", //your customer's name
        "email": "ajmalmirshaa2004@gmail.com",
        "contact": "7907883318"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    },
    "modal":{
                        escape:false,
                        onDismiss:()=>{
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Payment failed.',
                            })
                          
                        }
                    }
    
};
var rzp1 = new Razorpay(options);
rzp1.open();

    }
    function verifyPayment(payment,order){
      $.ajax({
       url : '/verify-payment',
      data: {
          payment,
          order
      },
      method:'post',
      success: (response)=>{
       if(response.status){
        location.href = '/ordersuccess'
       }
      }
      })
      
    }
  </script>




<%- include("../layouts/footer.ejs") %>